name: Release Build (Windows)

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  BUILD_TYPE: Debug

jobs:
  build-and-upload:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]

    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          if ("${{ matrix.arch }}" -eq "x86") {
            $cmakeArch = "Win32"
          } else {
            $cmakeArch = "x64"
          }
          $cmakeArgs = @(
            "-B", "${{ github.workspace }}/build-${{ matrix.arch }}"
            "-A", $cmakeArch
            "-DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}"
            "-DDISPLAYINFO_RELEASE_TAG=${{ github.event.release.tag_name }}"
          )
          cmake @cmakeArgs

      - name: Build
        run: |
          cmake --build ${{github.workspace}}/build-${{ matrix.arch }} --config ${{env.BUILD_TYPE}}

      # - name: Test
      #   working-directory: ${{github.workspace}}/build
      #   run: ctest -C ${{env.BUILD_TYPE}}

      - name: Package EXE into ZIP
        shell: pwsh
        run: |
          $distDir = "$env:GITHUB_WORKSPACE/dist"

          New-Item -ItemType Directory -Path $distDir -Force | Out-Null

          $artifactBareName = "DisplayInfo-${{ github.event.release.tag_name }}-${{ matrix.arch }}"
          $artifactPathParts = @{
            Path = "$env:GITHUB_WORKSPACE/build-${{ matrix.arch }}/${{env.BUILD_TYPE}}"
            ChildPath = $artifactBareName
          }
          $artifactPathPrefix = Join-Path @artifactPathParts

          $exePath = "$artifactPathPrefix.exe"
          $pdbPath = "$artifactPathPrefix.pdb"

          if (-not (Test-Path $exePath)) {
            throw "Expected executable not found: $exePath"
          }

          if (-not (Test-Path $pdbPath)) {
            throw "Expected PDB not found: $pdbPath"
          }

          $zipName = "$artifactBareName.zip"
          $zipPath = Join-Path $distDir $zipName

          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }

          Compress-Archive -Path @($exePath, $pdbPath) -DestinationPath $zipPath

          "ASSET_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload ZIP to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}
