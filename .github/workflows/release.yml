name: Release Build (Windows)

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  BUILD_TYPE: Debug

jobs:
  build-and-upload:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: |
          cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

      # - name: Test
      #   working-directory: ${{github.workspace}}/build
      #   run: ctest -C ${{env.BUILD_TYPE}}

      - name: Package EXE into ZIP
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "$env:GITHUB_WORKSPACE/dist" -Force | Out-Null
          $exePath = Join-Path "$env:GITHUB_WORKSPACE/build/${{env.BUILD_TYPE}}" "DisplayInfo.exe"
          if (-not (Test-Path $exePath)) {
            throw "Expected executable not found: $exePath"
          }

          $zipName = "DisplayInfo-${{ github.event.release.tag_name }}-windows-${{ env.BUILD_TYPE }}.zip"
          $zipPath = Join-Path "$env:GITHUB_WORKSPACE/dist" $zipName

          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }

          Compress-Archive -Path $exePath -DestinationPath $zipPath
          "ASSET_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload ZIP to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}
